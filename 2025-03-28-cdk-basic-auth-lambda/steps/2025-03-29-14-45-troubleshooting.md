# 2025-03-29 14:45 - Integration Tests Troubleshooting

## 問題

`pnpm test:integration:dev`コマンドが失敗しています。エラーの原因は、APIリクエストに送信されるJSONデータの形式が不正であることと、APIサーバーの問題が考えられます。

## 症状

1. APIリクエストに送信されるJSONデータに、キーと値のペアの間にカンマが欠けています。

    ```json
    // 実際に送信されているデータ（不正な形式）
    {"userId":"test-user""title":"Test Todo""completed":false"dueDate":"2025-12-31"}
    
    // 正しい形式であるべきデータ
    {"userId":"test-user","title":"Test Todo","completed":false,"dueDate":"2025-12-31"}
    ```

2. 最初はAPIリクエストが401 Unauthorizedエラーで失敗していましたが、修正後は502 Bad Gatewayエラーが発生しています。

## 試した解決策

1. `JSON.stringify`メソッドを使用してJSONデータを作成する方法を修正
   - 問題: `JSON.stringify`の出力にカンマが含まれていない
   - 原因: 不明（システム固有の問題の可能性あり）

2. 手動でJSONデータを作成する方法に変更
   - `jsonObj`オブジェクトを作成し、`JSON.stringify`で文字列化
   - 問題: 同じ問題が発生

3. 文字列連結を使用して手動でJSONデータを作成
   - 問題: 同じ問題が発生

4. AWSへのデプロイを再実行
   - 問題: 同じ問題が発生

5. HTTPクライアントライブラリを`axios`から`node-fetch`に変更
   - 問題: JSONデータの形式は修正されたが、401 Unauthorizedエラーが発生

6. APIエンドポイントの取得方法を修正
   - 問題: 環境に応じたAPIエンドポイントを正しく取得するように修正
   - 結果: 502 Bad Gatewayエラーが発生

## 現在の状況

- AWS Utils のテストは成功しています
- Todo API のテストは失敗しています（502 Bad Gateway エラー）
- `node-fetch`を使用することで、JSONデータの形式の問題は解決しましたが、APIサーバーの問題が発生しています

## 次のステップ

1. APIサーバーの問題を解決する
   - APIサーバーが正常に動作しているか確認
   - APIサーバーのログを確認
   - APIサーバーの設定を確認

2. APIのエンドポイントが正しいか確認する
   - CloudFormationから取得したAPIエンドポイントが正しいか確認
   - API Gatewayの設定を確認

3. 環境変数の設定を確認する
   - 開発環境と本番環境の設定が正しいか確認
   - 環境変数が正しく設定されているか確認

4. APIのログを確認する
   - CloudWatchログを確認して、APIリクエストの詳細を確認
   - エラーの原因を特定する

5. Lambda関数の設定を確認する
   - Lambda関数が正常に動作しているか確認
   - Lambda関数のログを確認
   - Lambda関数の設定を確認

## 注意点

- 502 Bad Gatewayエラーは、APIサーバーが正常に応答できないことを示しています
- APIサーバーの問題は、環境固有の問題である可能性があります
- テスト環境と本番環境で動作が異なる可能性があります
- APIのエンドポイントが正しくても、APIサーバーが正常に動作していないと502エラーが発生します
