# ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ã®å‹•ä½œã‚’ç¢ºèªã™ã‚‹

## å®Ÿæ–½å†…å®¹

1. Cloudflare Workers ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
2. ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã® WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹
3. ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¿®æ­£ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸ WebSocket ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶š
4. ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸ WebSocket ã‚µãƒ¼ãƒãƒ¼ã®å‹•ä½œã‚’ç¢ºèª

## å¤‰æ›´å†…å®¹

### 1. Cloudflare Workers ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
npm run deploy
```

ãƒ‡ãƒ—ãƒ­ã‚¤çµæœï¼š

```txt
> deploy
> wrangler deploy --minify


 â›…ï¸ wrangler 4.6.0
------------------

ğŸŒ€ Building list of assets...
ğŸŒ€ Starting asset upload...
ğŸŒ€ Found 1 new or modified static asset to upload. Proceeding with upload...
+ /websocket-client.html
Uploaded 1 of 1 assets
âœ¨ Success! Uploaded 1 file (1.03 sec)

Total Upload: 22.38 KiB / gzip: 8.91 KiB
Your worker has access to the following bindings:
- Assets:
  - Binding: ASSETS
Uploaded cf-ws-hono (11.06 sec)
Deployed cf-ws-hono triggers (0.55 sec)
  https://cf-ws-hono.dev.workers.dev
Current Version ID: ede41320-7b78-4f98-88ae-9a712ba8dfdf
```

ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸ URL: <https://cf-ws-hono.dev.workers.dev>

### 2. ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¿®æ­£

`test-websocket.js` ã‚’ä¿®æ­£ã—ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸ WebSocket ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸï¼š

```javascript
// WebSocketã‚µãƒ¼ãƒãƒ¼ã®URL
// ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒç”¨
// const WS_URL = 'ws://localhost:8787/ws';
// ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒç”¨
const WS_URL = 'wss://cf-ws-hono.dev-a42.workers.dev/ws';
```

## å‹•ä½œç¢ºèª

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å‹•ä½œç¢ºèª

    ```bash
    # ãƒ–ãƒ©ã‚¦ã‚¶ã§WebSocketã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’é–‹ã
    open https://cf-ws-hono.dev-a42.workers.dev/websocket-client
    ```

    ãƒ–ãƒ©ã‚¦ã‚¶ã§ WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒé–‹ãã€ã€Œæ¥ç¶šã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ WebSocket æ¥ç¶šã‚’ç¢ºç«‹ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€å—ä¿¡ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

2. ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã®å‹•ä½œç¢ºèª

    ```bash
    # ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
    node test-websocket.js
    ```

    å®Ÿè¡Œçµæœï¼š

    ```txt
    === WebSocketæ¥ç¶šãƒ†ã‚¹ãƒˆ ===
    æ¥ç¶šå…ˆ: wss://cf-ws-hono.dev-a42.workers.dev/ws
    âœ… æ¥ç¶šæˆåŠŸ
    
    === ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€å—ä¿¡ãƒ†ã‚¹ãƒˆ ===
    å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {
      type: 'connected'
      message: 'WebSocketæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸ'
      timestamp: '2025-04-01T09:48:27.382Z'
    }
    âœ… æ¥ç¶šç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
    é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {
      type: 'test'
      message: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™'
      timestamp: '2025-04-01T09:48:27.125Z'
    }
    å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {
      type: 'echo'
      message: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™'
      originalData: {
        type: 'test'
        message: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™'
        timestamp: '2025-04-01T09:48:27.125Z'
      }
      timestamp: '2025-04-01T09:48:27.415Z'
    }
    âœ… ã‚¨ã‚³ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡
    âœ… å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ­£ã—ãè¿”ã•ã‚Œã¾ã—ãŸ
    
    âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ
    ```

## ç¢ºèªäº‹é …

- [x] Cloudflare Workers ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨
- [x] ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã“ã¨
- [x] WebSocket ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨
- [x] WebSocket æ¥ç¶šãŒç¢ºç«‹ã§ãã‚‹ã“ã¨
- [x] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡ãŒã§ãã‚‹ã“ã¨
- [x] JSON å½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã§ãã‚‹ã“ã¨

## çµè«–

Cloudflare Workers ä¸Šã§ Hono ã‚’ä½¿ç”¨ã—ãŸ WebSocket ã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Cloudflare Workers ä¸Šã§ WebSocket ã‚’ä½¿ç”¨ã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãŒå¯èƒ½ã§ã‚ã‚‹ã“ã¨ãŒæ¤œè¨¼ã§ãã¾ã—ãŸã€‚

## å…¨ä½“ã®ã¾ã¨ã‚

1. ã‚¹ãƒ†ãƒƒãƒ—1: Cloudflare ç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–
2. ã‚¹ãƒ†ãƒƒãƒ—2: Hono ã® `public` ã® `index.html` ã‚’å‰Šé™¤ã—ã¦ API ã‚µãƒ¼ãƒãƒ¼ã«ç‰¹åŒ–
3. ã‚¹ãƒ†ãƒƒãƒ—3: Hono ã® WebSocket ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§ç¢ºèª
4. ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ã®å‹•ä½œã‚’ç¢ºèª

ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Œäº†ã—ã€Cloudflare Workers ä¸Šã§ Hono ã«ã‚ˆã‚‹ WebSocket ã‚µãƒ¼ãƒãƒ¼ãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã§ãã¾ã—ãŸã€‚
