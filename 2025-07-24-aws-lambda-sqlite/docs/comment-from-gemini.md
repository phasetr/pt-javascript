# FROM GEMINI

## AWS Lambda + EFS を利用したSQLiteの検討

このドキュメントは、AWS LambdaとEFSを組み合わせてSQLiteを安価に利用する方法について調査した結果をまとめたものです。主に簡単な社内プロジェクトやMVPでの利用を想定しています。

### 1. 技術的な実現可能性

AWS LambdaとEFSを組み合わせてSQLiteを利用することは、技術的に可能です。EFSはNFSv4ロッキングをサポートしており、これにより複数のLambdaインスタンスからの読み書きに対応できます。Lambda関数は、EFSにアクセスするためにVPC内で実行される必要があります。

### 2. 利点（MVPや社内プロジェクト向け）

* **コスト効率:** EFSは従量課金制であり、ストレージとスループットに対してのみ課金されます。低頻度利用の社内プロジェクトやMVPであれば、非常に安価に運用できる可能性があります。
* **RDBの利用:** NoSQLのDynamoDBではなく、リレーショナルデータベースであるSQLiteを利用できる点がメリットです。既存のリレーショナルデータベースの知識やツールを活かせます。

### 3. 考慮事項と制限

* **レイテンシ:** EFS経由でのSQLiteアクセスにはネットワークレイテンシ（一般的に100ms以上）が発生する可能性があり、ローカルファイルシステムアクセスに比べてパフォーマンスが低下する可能性があります。データベースのサイズ、同時接続数、書き込み操作によって変動します。
* **同時実行性（書き込み）:** SQLiteはインプロセスデータベースとして設計されており、複数のリーダーをサポートしますが、書き込みは一度に1つしかできません。高スループットの書き込み操作が必要な場合は、ボトルネックとなる可能性があります。
* **コールドスタート:** EFSの統合によりLambdaのコールドスタート時間が増加する可能性があります。Provisioned Concurrencyを利用することで、この影響を緩和できます。
* **WALモードの非推奨:** SQLiteのWAL（Write-Ahead Logging）モードは、EFSのようなNFSベースのファイルシステムではロッキングの問題から推奨されません。デフォルトのロールバックジャーナルモードを使用することが安全です。
* **VPC必須:** Lambda関数とEFSは同じVPC内に配置する必要があります。コストを抑えるために、MVPでは単一Availability ZoneやNAT GatewayなしのVPC構成も検討できます。

### 4. アーキテクチャの概要

1. **EFSファイルシステムの作成:** 選択したVPC内にEFSファイルシステムをセットアップします。MVPでは、General PurposeパフォーマンスモードとBursting Throughputモードが適していることが多いです。
2. **VPCの作成/設定:** Lambda関数とEFSのためにVPCを作成または設定します。コスト削減のため、単一AZやNAT Gatewayなしの構成も検討できます。
3. **Lambda関数の設定:**
    * Lambda関数をEFSと同じVPC内で実行するように設定します。
    * EFSファイルシステムをLambda関数の環境内の特定のパスをマウントします。
    * EFSアクセスポイントを使用して、ディレクトリへのアクセスを細かく制御することも可能です。
    * Lambdaコードは、マウントされたEFSパス上のSQLiteデータベースファイルと対話します。
4. **SQLiteの利用:**
    * EFS上にSQLiteデータベースファイルを初期化します。Lambda関数は、初回実行時にテーブルを作成するなどの初期設定を行うことができます。
    * SQLiteの単一ライターの制限に留意してください。低頻度の同時書き込みであれば許容範囲です。
    * 読み込み頻度が高い場合は、データベースのサイズが許せば、SQLiteデータベースファイルをEFSからLambdaの一時ストレージ（`/tmp`）にコピーして利用することで、レイテンシを削減できる可能性があります。

### 5. 結論

低頻度で書き込みが少なく、レイテンシが厳しくない社内プロジェクトやMVPであれば、AWS Lambda + SQLite + EFSの組み合わせは、安価にリレーショナルデータベースを利用する���常に有効な選択肢となります。ただし、SQLiteの単一ライターの制約を理解し、高スループットの書き込みや高い可用性が求められる本格的な運用には向かない点に注意が必要です。より大規模なアプリケーションや高いパフォーマンスが求められる場合は、Amazon DynamoDBやAmazon Aurora Serverlessなどのマネージドデータベースサービスの利用を検討すべきです。
