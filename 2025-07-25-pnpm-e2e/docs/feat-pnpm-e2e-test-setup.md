# pnpm E2Eテストサンプルプロジェクト作業計画書

作成日時: 2025-07-25

## プルリクエスト

- URL: <https://github.com/phasetr/pt-javascript/pull/3>

## 概要

pnpmモノレポ構成でE2Eテストのサンプルプロジェクトを実装します。HonoX + sql.js/D1/DynamoDB混成での動作確認を行い、並列実行可能なE2Eテスト環境を構築します。

### 当初想定

>データベースつきWebアプリに対してpnpm利用でE2Eテストを書くサンプルを作るプロジェクトです。適切なE2Eテストの構成調査がメインであるため、今回は厳密なモジュラーモノリス・鉄道指向・TDDには従いません。ただしpnpmパッケージ構成としてcore, web, db-itest, e2e-testなどのパッケージ分類には従います。ある程度先は見据えつつインクリメンタルに対応します。大まかに次のような対応を考えています。
>
>- MPAフレームワークとしてHonoX利用
>- データベースはsql.js（オンメモリSQLite）, Cloudflare D1（ローカルでのwrangler利用）, DynamoDB混成で利用できるようにする
>- sql.js・DynamoDBはviteで動作、D1はwranglerで動作させる
>- D1はwranglerで開発サーバーが動作すればよく、wrangler実行でのE2Eテストは考えない
>- DynamoDBはDockerでのdynamodb-local利用
>- sql.js・DynamoDBでのE2Eが重要
>- ごく簡単なCRUDアプリを作って、初期投入データの一覧・要素追加・編集・削除のE2Eを並列実行できるようにする：DBの独立性確保と別途起動している可能性がある開発サーバー・DBとの不干渉が保てるかが重要。データのシーディング・フィクチャー適用が適切に進むかも重要
>
>対応順としては次のような形を考えています。
>
>- coreパッケージでdrizzleでのスキーマ作成とマイグレーションファイル作成
>- coreパッケージでsql.js想定のstorageを書く
>- webパッケージでvite+sql.js前提のアプリを書き、オンメモリにマイグレーション・シーディングが適用されて画面が動くか確認
>- webパッケージでwranglerでもアプリが動くか確認：すぐにできないようなら一旦断念して、まずはvite+sql.js前提のE2Eに集中（vite+sql.jsとwranglerの両立は別プロジェクトで継続対応まで含む）
>- E2Eテストを書く：URL固定などまずはとにかく動くようにする
>- E2Eテストの調整：並列実行に向けた調整
>- vite+DynamoDBでのアプリ実装・動作実験
>- DynamoDBでのE2E動作確認
>
>DynamoDBも入れる点がやや異常な構成ですが、様々な設定の場合分けの参考用で、vite, wrangler混成構成がうまく行って時間があれば最後に検討します。初めから考慮した形にしないとあとで大変更が起きてシステムが破壊されるため最初から要件として盛り込んでいるにすぎません。
>
>大まかな要件は以上の通りです。まずはブランチ・プルリクを切って作業計画を立ててください。そこでやりとりしながら細部を埋めます。

## 開発方針

- 今回は厳格なモジュラーモノリス、鉄道指向、TDDは採用しない
- E2Eテスト重視の構成
- 単体テストは作成しない
- TypeScriptの厳格な設定を採用
- biomeをリンター・フォーマッターとして使用
- lint:fixは "biome check . --fix --diagnostic-level=error" を使用
- pnpm checkコマンドは使用（テスト部分を除く）

## 作業計画

### フェーズ1: プロジェクト初期設定 - 完了

1. pnpmワークスペースの設定
   - pnpm-workspace.yamlの作成
   - ルートpackage.jsonの設定
   - TypeScript/biome設定
   - **評価項目**: pnpm checkコマンドの設定と動作確認
   - **ユーザー確認後**: 作業概要と進捗を整理してコミット

#### 対応内容

1. pnpmワークスペースの設定完了
   - pnpm-workspace.yaml作成
   - ルートpackage.json作成（TypeScript + biome設定）
   - tsconfig.json作成（厳格な設定）
   - biome.json作成（リンター・フォーマッター設定）
   - .gitignore作成
   - pnpm checkコマンドの動作確認完了

**確認事項**:

- pnpm install成功
- pnpm check動作確認（リント・ビルド・型チェック）
- biomeによるフォーマット適用

### フェーズ2: パッケージ構成

1. coreパッケージの作成 - 完了
   - drizzleによるdbモジュール実装
   - numbersテーブル（id, name, number, created_at, updated_at）
   - 基本的なCRUD操作の実装
   - 初期データ5件のマイグレーション
   - **評価項目**: coreパッケージのビルド成功
   - **ユーザー確認後**: 作業概要と進捗を整理してコミット
   - **重要な発見**: core内で(sqliteの)マイグレーションをしようとしてはならない。このために不要な`@libsql/client`が必要になり、webパッケージで事故が起きる。

2. webパッケージの作成（HonoX）とCRUD実装
   - HonoXのセットアップ
   - 重ねて注意：厳格なモジュラーモノリス・鉄道指向・TDDは採用しない
   - 画面のレイアウトは`_renderer.tsx`利用
   - `tailwind`ライクに各要素に直接css適用
   - numbersテーブルに対するCRUD画面
   - sql.js/wrangler/DynamoDB切り替え可能な設計（実装はsql.jsのみ）
   - **評価項目**: sql.jsでの開発サーバー起動と画面での動作確認（ユーザー確認必須）
   - **ユーザー確認後**: 作業概要と進捗を整理してコミット

3. e2e-testパッケージの作成（段階的実装）
   - 第1段階: 手動起動のWebサーバーに対するテスト（固定URL）
     - Playwrightの基本設定
     - **評価項目**: 固定URLでのE2Eテスト動作確認
     - **ユーザー確認後**: 作業概要と進捗を整理してコミット
   - 第2段階: Webサーバーの自動起動対応
     - ポート独立性の確保
     - **評価項目**: 自動起動でのE2Eテスト動作確認
     - **ユーザー確認後**: 作業概要と進捗を整理してコミット
   - 第3段階: オンメモリDB利用と並列実行
     - **評価項目**: E2Eテストの並列実行成功
     - **ユーザー確認後**: 作業概要と進捗を整理してコミット

### フェーズ3: wrangler対応

1. wranglerでの開発サーバー起動
   - wrangler設定の追加
   - **評価項目**: wranglerでの画面動作確認（ユーザー確認必須）
   - **評価項目**: sql.jsでのE2Eテストが破壊されないことの確認
   - **ユーザー確認後**: 作業概要と進捗を整理してコミット

### フェーズ4: DynamoDB対応

1. DynamoDB実装
   - DynamoDB localの設定
   - storage層のDynamoDB実装
   - **評価項目**: DynamoDBでの画面動作確認
   - **評価項目**: DynamoDBでのE2Eテスト動作
   - **ユーザー確認後**: 作業概要と進捗を整理してコミット

### フェーズ5: 最終確認

1. 全体テストの実行
   - **定期確認**（pnpm check）の無エラー完了
   - E2Eテストの実行
   - **ユーザー確認後**: 作業概要と進捗を整理してコミット

## 成功基準

- pnpm checkが無エラーで完了すること
- E2Eテストが並列実行可能なこと
- sql.jsとDynamoDB localの両方でテストが動作すること
