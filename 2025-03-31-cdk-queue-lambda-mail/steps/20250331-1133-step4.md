# ステップ4: CDKコードの書き換え

## 実施内容

CDKコードを書き換えて、作成したLambda関数をAWSにデプロイできるようにしました。環境としては`dev`のみで、最低限のスペックで実装しました。

### 変更したファイル

1. **packages/cqlm/lib/cqlm-stack.ts**: CDKスタックの定義
   - SQSキューとSNSトピックの設定を拡張
   - Lambda関数の追加
   - IAMロールとポリシーの設定
   - SQSキューをLambda関数のイベントソースとして設定
   - 環境変数の設定

2. **packages/cqlm/bin/cqlm.ts**: CDKアプリケーションのエントリーポイント
   - コマンドライン引数から環境を取得する機能を追加
   - 環境ごとにスタックを作成する機能を追加
   - タグ付けの追加

3. **package.json**: ルートのパッケージ設定
   - デプロイコマンドの追加
   - Lambda関数ビルドコマンドの追加
   - デプロイ・削除コマンドの追加

4. **packages/lambda/build.sh**: Lambda関数のビルドスクリプト
   - 依存関係のインストール
   - TypeScriptのコンパイル
   - ビルド結果の検証

## 実装の特徴

1. **リソース命名**: プロジェクトの略称（CQLM）と環境名をプレフィックスとして使用
2. **クリーンアップ**: 開発環境ではスタック削除時にリソースも削除するように設定
3. **最小権限の原則**: Lambda関数に必要最小限の権限のみを付与
4. **ビルド自動化**: Lambda関数のビルドとデプロイを自動化するスクリプトを追加

## AWS構成

1. **SQSキュー**: メッセージを一時的に保存し、Lambda関数に渡す
2. **SNSトピック**: メッセージの発行先として機能
3. **Lambda関数**: SQSキューからメッセージを受け取り、メール送信処理を実行
4. **IAMロール**: Lambda関数に必要な権限を付与
5. **CloudWatch Logs**: Lambda関数のログを保存（1週間の保持期間）

## デプロイ方法

### 開発環境へのデプロイ

```bash
# Lambda関数のビルドとdev環境へのデプロイ
pnpm run deploy:dev
```

### スタックの削除

```bash
# dev環境のスタックを削除
pnpm run destroy:dev
```

## 確認事項

- [x] CDKスタックにLambda関数が追加されているか
- [x] SQSキューがLambda関数のイベントソースとして設定されているか
- [x] Lambda関数にSESの権限が付与されているか
- [x] 環境変数が適切に設定されているか
- [x] デプロイコマンドが追加されているか

## 次のステップ

次のステップでは、Lambda関数でメール送信処理を実装し、実際にAWSにデプロイして動作検証を行います。
