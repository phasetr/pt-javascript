# ステップ6: AWSにデプロイして動作検証

## 実施内容

AWSにデプロイして動作検証を行うための準備を行いました。特にキューイングが確実にわかる形で検証できるような手法を検討し、検証スクリプトを作成しました。

### 作成したファイル

1. **packages/cqlm/scripts/verify.ts**: 動作検証用のスクリプト
   - SNSトピックにメッセージを発行
   - SQSキューの属性を取得して、メッセージがキューに入っているかを確認
   - CloudWatchログを取得して、Lambda関数が実行されたことを確認
   - メール受信の確認を促すメッセージを表示

### 変更したファイル

1. **packages/cqlm/package.json**: CDKパッケージの設定
   - AWS SDKの依存関係を追加
   - 検証スクリプトを実行するための `verify` スクリプトを追加

2. **package.json**: ルートのパッケージ設定
   - 検証コマンドを追加
   - 依存関係をインストールするコマンドを追加

## 実装の特徴

1. **SNSトピックへのメッセージ発行**: テストメッセージをSNSトピックに発行し、キューイングをトリガー
2. **SQSキューの属性確認**: キューの属性を取得して、メッセージがキューに入っているかを確認
3. **CloudWatchログの確認**: Lambda関数の実行ログを取得して、処理が行われたことを確認
4. **メール受信の確認**: 実際にメールが送信されたことを確認するための手順を表示

## デプロイと検証の手順

### 1. 依存関係のインストール

```bash
# 全てのパッケージの依存関係をインストール
pnpm run install:all
```

### 2. AWSアカウントIDの設定

```bash
# AWSアカウントIDを環境変数に設定
export AWS_ACCOUNT_ID=<your-aws-account-id>
```

### 3. AWSへのデプロイ

```bash
# Lambda関数をビルドしてAWSにデプロイ
pnpm run deploy:dev
```

### 4. 動作検証

```bash
# 検証スクリプトを実行
pnpm run verify
```

### 5. 検証結果の確認

1. コンソール出力を確認
   - SNSトピックへのメッセージ発行が成功したか
   - SQSキューの属性が正しいか
   - CloudWatchログが取得できたか

2. メールの受信を確認
   - 指定したメールアドレス（<phasetr+sample1@gmail.com>または<phasetr+sample2@gmail.com>）にメールが届いているか
   - メールの内容が正しいか

3. CloudWatchログを確認
   - Lambda関数の実行ログを確認
   - エラーが発生していないか

## キューイングの確認方法

1. **SNSトピックへのメッセージ発行**: SNSトピックにメッセージを発行すると、SNSからSQSキューにメッセージが送信されます。
2. **SQSキューの属性確認**: SQSキューの属性を取得して、メッセージがキューに入っているかを確認します。
   - `ApproximateNumberOfMessages`: キュー内のメッセージ数
   - `ApproximateNumberOfMessagesNotVisible`: 処理中のメッセージ数
3. **CloudWatchログの確認**: Lambda関数の実行ログを取得して、SQSキューからメッセージが取り出されて処理されたことを確認します。
4. **メール受信の確認**: 最終的に、メールが送信されたことを確認します。

## 確認事項

- [x] デプロイコマンドが正しく設定されているか
- [x] 検証スクリプトが作成されているか
- [x] キューイングが確実にわかる形で検証できるか
- [x] 検証結果の確認方法が明確か

## 次のステップ

これで全てのステップが完了しました。実際にAWSにデプロイして動作検証を行い、システムが正しく動作することを確認してください。
